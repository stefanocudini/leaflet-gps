/* 
 * Leaflet Control GPS v1.0.0 - 2014-09-05 
 * 
 * Copyright 2014 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * http://labs.easyblog.it/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demos: 
 * http://labs.easyblog.it/maps/leaflet-gps/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-gps.git 
 * 
 */
(function(){L.Control.Gps=L.Control.extend({includes:L.Mixin.Events,options:{autoActive:!1,autoCenter:!1,maxZoom:null,marker:null,textErr:null,callErr:null,radius:2,style:{weight:3,color:"#e03",fill:!1},title:"Center map on your location",position:"bottomright"},initialize:function(a){a&&a.style&&(a.style=L.Util.extend({},this.options.style,a.style)),L.Util.setOptions(this,a),this._errorFunc=this.options.callErr||this.showAlert,this._isActive=!1,this._firstMoved=!1,this._currentLocation=null},onAdd:function(a){this._map=a;var b=L.DomUtil.create("div","leaflet-control-gps");return this._button=L.DomUtil.create("a","gps-button",b),this._button.href="#",this._button.title=this.options.title,L.DomEvent.on(this._button,"click",L.DomEvent.stop,this).on(this._button,"click",this._switchGps,this),this._alert=L.DomUtil.create("div","gps-alert",b),this._alert.style.display="none",this._gpsMarker=this.options.marker?this.options.marker:new L.CircleMarker([0,0],this.options.style),this._updateRadius(),this._map.on("locationfound",this._drawGps,this).on("locationerror",this._errorGps,this).on("zoomend",this._updateRadius,this),this.options.autoActive&&this.activate(),b},_updateRadius:function(){var a=this._map.getZoom(),b=this._map.options.crs.scale(a);this._gpsMarker.setRadius(this.options.radius*b),this._gpsMarker.redraw()},onRemove:function(){this.deactivate()},_switchGps:function(){this._isActive?this.deactivate():this.activate()},getLocation:function(){return this._currentLocation},activate:function(){this._isActive=!0,this._map.addLayer(this._gpsMarker)},deactivate:function(){this._isActive=!1,this._firstMoved=!1,L.DomUtil.removeClass(this._button,"active"),this._map.removeLayer(this._gpsMarker),this.fire("gpsdisabled")},_drawGps:function(a){this._currentLocation=a.latlng,this._gpsMarker.setLatLng(a.latlng),!this._isActive||this._firstMoved&&!this.options.autoCenter||this._moveTo(a.latlng),this.fire("gpslocated",{latlng:a.latlng,marker:this._gpsMarker}),L.DomUtil.addClass(this._button,"active")},_moveTo:function(a){this._firstMoved=!0,this.options.maxZoom?this._map.setView(a,Math.min(this._map.getZoom(),this.options.maxZoom)):this._map.panTo(a)},_errorGps:function(a){this.deactivate(),this._errorFunc.call(this,this.options.textErr||a.message)},showAlert:function(a){this._alert.style.display="block",this._alert.innerHTML=a;var b=this;clearTimeout(this.timerAlert),this.timerAlert=setTimeout(function(){b._alert.style.display="none"},2e3)}}),L.control.gps=function(a){return new L.Control.Gps(a)}}).call(this);